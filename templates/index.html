<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Intelligent AI Chatbot - Advanced Voice & Text Assistant">
    <title>ü§ñ AI Chatbot | Intelligent Voice Assistant</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --primary-light: #a78bfa;
            --secondary: #0ea5e9;
            --bg-dark: #09090b;
            --bg-card: #18181b;
            --bg-sidebar: #111114;
            --bg-hover: #27272a;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #27272a;
            --user-bubble: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
            --bot-bubble: rgba(39, 39, 42, 0.8);
            --radius-xl: 1.5rem;
            --radius-lg: 1.25rem;
            --radius-md: 0.75rem;
            --radius-full: 9999px;
            --shadow-glow: 0 0 20px rgba(139, 92, 246, 0.15);
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--border) transparent;
        }

        *::-webkit-scrollbar {
            width: 6px;
        }

        *::-webkit-scrollbar-thumb {
            background-color: var(--border);
            border-radius: 10px;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        h1,
        h2,
        h3,
        .logo {
            font-family: 'Outfit', sans-serif;
        }

        /* Layout Structure */
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            transition: transform 0.3s ease;
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -280px;
                z-index: 100;
                height: 100%;
            }

            .sidebar.open {
                transform: translateX(280px);
            }
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .logo-icon {
            font-size: 2rem;
            background: var(--user-bubble);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .nav-section {
            flex: 1;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .new-chat-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.875rem;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .new-chat-btn:hover {
            background: var(--bg-hover);
            border-color: var(--primary);
        }

        .lang-switcher {
            display: flex;
            background: var(--bg-dark);
            padding: 4px;
            border-radius: var(--radius-full);
            margin-top: auto;
            border: 1px solid var(--border);
        }

        .lang-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-full);
            cursor: pointer;
            font-weight: 600;
            font-size: 0.75rem;
            transition: all 0.2s;
        }

        .lang-btn.active {
            background: var(--user-bubble);
            color: white;
        }

        /* Main Chat Area */
        .main-chat {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: radial-gradient(circle at 50% 50%, rgba(139, 92, 246, 0.05) 0%, transparent 70%);
        }

        .chat-header {
            height: 64px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            background: rgba(9, 9, 11, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-radius: var(--radius-full);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-pill.offline {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 10px currentColor;
        }

        /* Chat Messages */
        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding-bottom: 151px;
            /* space for input area */
        }

        .message {
            max-width: 80%;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            align-self: flex-end;
        }

        .bot-message {
            align-self: flex-start;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .user-avatar {
            background: var(--user-bubble);
            margin-left: auto;
        }

        .bot-avatar {
            background: var(--bg-card);
            border: 1px solid var(--border);
        }

        .bubble {
            padding: 1rem 1.25rem;
            border-radius: var(--radius-lg);
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
        }

        .user-message .bubble {
            background: var(--user-bubble);
            color: white;
            border-bottom-right-radius: 4px;
            box-shadow: var(--shadow-glow);
        }

        .bot-message .bubble {
            background: var(--bot-bubble);
            color: var(--text-primary);
            border-bottom-left-radius: 4px;
            border: 1px solid var(--border);
            backdrop-filter: blur(8px);
        }

        .message-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            opacity: 0;
            transition: var(--transition);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .action-icon-btn {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .action-icon-btn:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .message-info {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .bot-message .message-info {
            display: flex;
            gap: 1rem;
        }

        .intent-tag {
            background: rgba(139, 92, 246, 0.1);
            color: var(--primary-light);
            padding: 1px 6px;
            border-radius: 4px;
        }

        /* Transcription Box (Floating inside chat) */
        .transcription {
            font-style: italic;
            opacity: 0.8;
            font-size: 0.85rem;
            margin-bottom: 0.5rem;
        }

        /* Typing Indicator */
        .typing {
            display: flex;
            gap: 4px;
            padding: 1rem 1.25rem;
            background: var(--bot-bubble);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border);
            width: fit-content;
        }

        .typing span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        /* Input Area */
        .input-area-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem 2rem;
            background: linear-gradient(to top, var(--bg-dark) 50%, transparent);
            z-index: 5;
        }

        .input-container {
            max-width: 800px;
            margin: 0 auto;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            display: flex;
            align-items: flex-end;
            padding: 8px 12px;
            gap: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }

        .input-container:focus-within {
            border-color: var(--primary);
            box-shadow: var(--shadow-glow);
        }

        textarea {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.95rem;
            padding: 12px;
            max-height: 200px;
            resize: none;
            outline: none;
            min-height: 48px;
        }

        .action-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            position: relative;
        }

        .action-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .send-btn {
            background: var(--user-bubble);
            color: white;
        }

        .send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }

        .record-btn.recording {
            color: var(--accent);
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(244, 63, 94, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(244, 63, 94, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(244, 63, 94, 0);
            }
        }

        .waveform {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 3px;
            height: 20px;
            align-items: center;
        }

        .wb {
            width: 3px;
            background: var(--accent);
            border-radius: 10px;
            animation: wave 0.8s infinite;
        }

        @keyframes wave {

            0%,
            100% {
                height: 5px;
            }

            50% {
                height: 20px;
            }
        }

        /* Quick Suggestions */
        .suggestions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .suggestion-chip {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            border-color: var(--primary);
            color: var(--text-primary);
        }

        /* RTL Adjustments */
        body.rtl {
            direction: rtl;
        }

        body.rtl .sidebar {
            border-right: none;
            border-left: 1px solid var(--border);
        }

        body.rtl .user-message {
            align-self: flex-start;
        }

        body.rtl .bot-message {
            align-self: flex-end;
        }

        body.rtl .user-message .bubble {
            border-bottom-right-radius: var(--radius-lg);
            border-bottom-left-radius: 4px;
        }

        body.rtl .bot-message .bubble {
            border-bottom-left-radius: var(--radius-lg);
            border-bottom-right-radius: 4px;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="en">
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo-section">
                <span class="logo-icon">ü§ñ</span>
                <span class="logo-text">AI CHATBOT</span>
            </div>

            <button class="new-chat-btn" onclick="newChat()">
                <span>+</span> <span class="nav-label">New Chat</span>
            </button>

            <div class="nav-section">
                <div class="nav-item active" id="btnHome">
                    <span>üè†</span> <span class="nav-label">Dashboard</span>
                </div>
                <div class="nav-item" id="btnHistory">
                    <span>üìÖ</span> <span class="nav-label">History</span>
                </div>
                <div class="nav-item" id="btnSettings">
                    <span>‚öôÔ∏è</span> <span class="nav-label">Settings</span>
                </div>
            </div>

            <div class="lang-switcher">
                <button class="lang-btn active" id="langEn" onclick="setLanguage('en')">English</button>
                <button class="lang-btn" id="langAr" onclick="setLanguage('ar')">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</button>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="main-chat">
            <header class="chat-header">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="font-weight: 600;" id="chatTitle">Intelligent AI Voice Assistant</div>
                </div>
                <div id="statusPill" class="status-pill">
                    <span class="status-dot"></span>
                    <span id="statusText">System Online</span>
                </div>
            </header>

            <div class="messages-container" id="messagesContainer">
                <!-- Welcome Message -->
                <div class="message bot-message">
                    <div class="bot-avatar avatar">ü§ñ</div>
                    <div class="bubble">
                        Hello! I'm your Intelligent AI Assistant. How can I help you today?
                    </div>
                </div>
            </div>

            <div class="input-area-wrapper">
                <div class="suggestions" id="suggestions">
                    <!-- Suggestions will be populated by JS -->
                </div>
                <div class="input-container">
                    <button class="action-btn record-btn" id="recordBtn" title="Voice Input">
                        <span id="micIcon">üéôÔ∏è</span>
                        <div id="waveform" class="waveform hidden">
                            <div class="wb" style="animation-delay: 0.1s"></div>
                            <div class="wb" style="animation-delay: 0.2s"></div>
                            <div class="wb" style="animation-delay: 0.3s"></div>
                            <div class="wb" style="animation-delay: 0.4s"></div>
                        </div>
                    </button>

                    <textarea id="textInput" placeholder="Send a message..." rows="1"></textarea>

                    <button class="action-btn send-btn" id="sendBtn">
                        <span id="sendIcon">‚úàÔ∏è</span>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script>
        // State
        let currentLang = 'en';
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let isTyping = false;

        const TRANSLATIONS = {
            en: {
                title: 'Intelligent AI Assistant',
                dashboard: 'Dashboard',
                history: 'History',
                settings: 'Settings',
                newChat: 'New Chat',
                online: 'System Online',
                offline: 'Offline',
                placeholder: 'Send a message...',
                welcome: "Hello! I'm your Intelligent AI Assistant. How can I help you today?",
                intent: 'Intent',
                confidence: 'Confidence',
                accuracy: 'accuracy',
                listening: 'Listening...',
                analyzing: 'Thinking...',
                copy: 'Copy',
                listen: 'Listen',
                suggestions: ['Who are you?', 'Tell me a joke', 'What can you do?', 'Weather']
            },
            ar: {
                title: 'ŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä ÿßŸÑÿ∞ŸÉŸä',
                dashboard: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ',
                history: 'ÿßŸÑÿ≥ÿ¨ŸÑ',
                settings: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™',
                newChat: 'ŸÖÿ≠ÿßÿØÿ´ÿ© ÿ¨ÿØŸäÿØÿ©',
                online: 'ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÖÿ™ÿµŸÑ',
                offline: 'ÿ∫Ÿäÿ± ŸÖÿ™ÿµŸÑ',
                placeholder: 'ÿ£ÿ±ÿ≥ŸÑ ÿ±ÿ≥ÿßŸÑÿ©...',
                welcome: "ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿ£ŸÜÿß ŸÖÿ≥ÿßÿπÿØŸÉ ÿßŸÑÿ∞ŸÉŸä. ŸÉŸäŸÅ ŸäŸÖŸÉŸÜŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ ÿßŸÑŸäŸàŸÖÿü",
                intent: 'ÿßŸÑŸÜŸäÿ©',
                confidence: 'ÿßŸÑÿ´ŸÇÿ©',
                accuracy: 'ÿØŸÇÿ©',
                listening: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ...',
                analyzing: 'ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ŸÅŸÉŸäÿ±...',
                copy: 'ŸÜÿ≥ÿÆ',
                listen: 'ÿßÿ≥ÿ™ŸÖÿßÿπ',
                suggestions: ['ŸÖŸÜ ÿ£ŸÜÿ™ÿü', 'ŸÇŸÑ ŸÑŸä ŸÜŸÉÿ™ÿ©', 'ŸÖÿßÿ∞ÿß ÿ™ÿ≥ÿ™ÿ∑Ÿäÿπ ÿ£ŸÜ ÿ™ŸÅÿπŸÑÿü', 'ÿßŸÑÿ∑ŸÇÿ≥']
            }
        };

        // DOM Elements
        const textInput = document.getElementById('textInput');
        const sendBtn = document.getElementById('sendBtn');
        const recordBtn = document.getElementById('recordBtn');
        const messagesContainer = document.getElementById('messagesContainer');
        const statusPill = document.getElementById('statusPill');
        const statusText = document.getElementById('statusText');
        const suggestionsContainer = document.getElementById('suggestions');

        // Functions
        function setLanguage(lang) {
            currentLang = lang;
            const t = TRANSLATIONS[lang];

            document.body.className = lang === 'ar' ? 'rtl' : 'en';
            document.getElementById('chatTitle').textContent = t.title;
            document.querySelector('#btnHome .nav-label').textContent = t.dashboard;
            document.querySelector('#btnHistory .nav-label').textContent = t.history;
            document.querySelector('#btnSettings .nav-label').textContent = t.settings;
            document.querySelector('.new-chat-btn .nav-label').textContent = t.newChat;
            textInput.placeholder = t.placeholder;

            // Toggle active classes on buttons
            document.getElementById('langEn').classList.toggle('active', lang === 'en');
            document.getElementById('langAr').classList.toggle('active', lang === 'ar');

            // Refresh suggestions
            renderSuggestions();
        }

        function renderSuggestions() {
            const t = TRANSLATIONS[currentLang];
            suggestionsContainer.innerHTML = '';
            t.suggestions.forEach(s => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = s;
                chip.onclick = () => {
                    textInput.value = s;
                    handleSend();
                };
                suggestionsContainer.appendChild(chip);
            });
        }

        function addMessage(text, isUser, meta = null, transcription = null) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${isUser ? 'user-message' : 'bot-message'}`;
            const t = TRANSLATIONS[currentLang];

            let metaHtml = '';
            if (meta) {
                const intentLabel = currentLang === 'ar' ? t.intent : 'Intent';
                metaHtml = `<div class="message-info">
                    <span class="intent-tag">${meta.intent}</span>
                    <span>${(meta.confidence * 100).toFixed(0)}% ${t.accuracy}</span>
                </div>`;
            }

            let transcriptionHtml = '';
            if (transcription) {
                transcriptionHtml = `<div class="transcription">"${transcription}"</div>`;
            }

            let actionsHtml = '';
            if (!isUser) {
                actionsHtml = `
                    <div class="message-actions">
                        <button class="action-icon-btn" onclick="copyToClipboard(\`${text.replace(/`/g, '\\`')}\`, this)">
                            <span>üìã</span> ${t.copy}
                        </button>
                        <button class="action-icon-btn" onclick="speak(\`${text.replace(/`/g, '\\`')}\`)">
                            <span>üîä</span> ${t.listen}
                        </button>
                    </div>
                `;
            }

            msgDiv.innerHTML = `
                <div class="${isUser ? 'user-avatar' : 'bot-avatar'} avatar">${isUser ? 'üë§' : 'ü§ñ'}</div>
                <div class="bubble">
                    ${transcriptionHtml}
                    ${text}
                </div>
                ${metaHtml}
                ${actionsHtml}
            `;

            messagesContainer.appendChild(msgDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function newChat() {
            messagesContainer.innerHTML = '';
            const t = TRANSLATIONS[currentLang];
            addMessage(t.welcome, false);
        }

        async function copyToClipboard(text, btn) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = btn.innerHTML;
                btn.innerHTML = '‚úÖ Copied!';
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            } catch (err) {
                console.error('Failed to copy!', err);
            }
        }

        function showTyping() {
            if (isTyping) return;
            isTyping = true;
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot-message typing-container';
            typingDiv.id = 'typingIndicator';
            typingDiv.innerHTML = `
                <div class="bot-avatar avatar">ü§ñ</div>
                <div class="typing">
                    <span></span><span></span><span></span>
                </div>
            `;
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTyping() {
            const typingDiv = document.getElementById('typingIndicator');
            if (typingDiv) typingDiv.remove();
            isTyping = false;
        }

        async function handleSend() {
            const text = textInput.value.trim();
            if (!text) return;

            textInput.value = '';
            textInput.style.height = 'auto';

            addMessage(text, true);
            showTyping();

            try {
                const response = await fetch('/api/process_text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: text })
                });
                const data = await response.json();

                hideTyping();
                if (data.success) {
                    addMessage(data.response, false, { intent: data.intent, confidence: data.confidence });
                    speak(data.response);
                } else {
                    addMessage("Sorry, I encountered an error.", false);
                }
            } catch (err) {
                hideTyping();
                addMessage("Connection error. Is the server running?", false);
            }
        }

        async function speak(text) {
            try {
                const response = await fetch('/api/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
                if (response.ok) {
                    const blob = await response.blob();
                    const audio = new Audio(URL.createObjectURL(blob));
                    audio.play();
                }
            } catch (e) { console.error("TTS error", e); }
        }

        // Voice Handling
        recordBtn.onclick = async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        sendAudio(audioBlob);
                    };
                    mediaRecorder.start();
                    isRecording = true;
                    recordBtn.classList.add('recording');
                    document.getElementById('micIcon').classList.add('hidden');
                    document.getElementById('waveform').classList.remove('hidden');
                } catch (e) { alert("Microphone access denied"); }
            } else {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(t => t.stop());
                isRecording = false;
                recordBtn.classList.remove('recording');
                document.getElementById('micIcon').classList.remove('hidden');
                document.getElementById('waveform').classList.add('hidden');
            }
        };

        async function sendAudio(blob) {
            showTyping();
            const formData = new FormData();
            formData.append('audio', blob, 'recording.wav');

            try {
                const response = await fetch('/api/process_audio', { method: 'POST', body: formData });
                const data = await response.json();
                hideTyping();
                if (data.success) {
                    addMessage(data.response, false,
                        { intent: data.intent, confidence: data.confidence },
                        data.transcription
                    );
                    speak(data.response);
                }
            } catch (e) {
                hideTyping();
                addMessage("Error processing audio.", false);
            }
        }

        // Event Listeners
        sendBtn.onclick = handleSend;
        textInput.onkeydown = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        };
        textInput.oninput = () => {
            textInput.style.height = 'auto';
            textInput.style.height = textInput.scrollHeight + 'px';
        };

        // Status Check
        async function checkStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                if (data.model_loaded) {
                    statusPill.classList.remove('offline');
                    statusText.textContent = TRANSLATIONS[currentLang].online;
                }
            } catch (e) {
                statusPill.classList.add('offline');
                statusText.textContent = TRANSLATIONS[currentLang].offline;
            }
        }

        // Init
        setLanguage('en');
        checkStatus();
        setInterval(checkStatus, 10000);
    </script>
</body>

</html>